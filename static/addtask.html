<html>

<head>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <link rel="stylesheet" href="style.css">
    <link rel="icon" href="logo.png" type="image/png">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/typescript.min.js"></script>
    <script src="element-table.js" type="module"></script>
    <script src="element-grid.js" type="module"></script>
    <script src="element-contextmenu.js" type="module"></script>
    <script src="widget-image.js" type="module"></script>
    <script src="widget-code.js" type="module"></script>
    <script src="widget-text.js" type="module"></script>
    <script src="widget-taskstatus.js" type="module"></script>
    <script src="widget-tasktype.js" type="module"></script>
    <script src="widget-taskid.js" type="module"></script>
    <script src="widget-taskname.js" type="module"></script>
     <script src="widget-hashimg.js" type="module"></script>
     <script src="widget-multi.js" type="module"></script>
     <script src="widget-transitions.js" type="module"></script>
     <script src="header.js"></script>
</head>

<body>
    <div id="header-placeholder"></div>
    <h2>Add New Task</h2>
    <form id="addTaskForm">
        <label for="scriptSelect">Select Script:</label>
        <select id="scriptSelect" required>
            <option value="">-- Choose a script --</option>
        </select><br><br>

        <label for="taskName">Task Name:</label>
        <input type="text" id="taskName" placeholder="Optional task name"><br><br>

        <label for="taskData">Data (JSON):</label>
        <textarea id="taskData" rows="10" cols="50" placeholder='{"key": "value"}'></textarea><br><br>

        <label for="transitions">Transitions (JSON):</label>
        <textarea id="transitions" rows="5" cols="50" placeholder='[]'></textarea><br><br>

        <label for="status">Initial Status:</label>
        <select id="status">
            <option value="0">Awaiting</option>
            <option value="4">Paused</option>
        </select><br><br>

        <button type="submit">Add Task</button>
    </form>

    <script>
        const headers = {};
        if (localStorage.hasOwnProperty("jwt_token")) {
            headers["Authorization"] = `Bearer ${localStorage["jwt_token"]}`;
        }

        let library = [];

        // Fetch library
        fetch("/library", { headers })
            .then(response => response.json())
            .then(data => {
                library = data;
                const select = document.getElementById('scriptSelect');
                data.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.filename;
                    option.textContent = item.name || item.filename;
                    select.appendChild(option);
                });

                // Check for script parameter in URL
                const urlParams = new URLSearchParams(window.location.search);
                const scriptParam = urlParams.get('script');
                if (scriptParam) {
                    select.value = scriptParam;
                    select.dispatchEvent(new Event('change')); // Trigger change event to fill form
                }
            })
            .catch(err => console.error('Failed to load library:', err));

        // Handle script selection
        document.getElementById('scriptSelect').addEventListener('change', function() {
            const selected = library.find(item => item.filename === this.value);
            if (selected) {
                document.getElementById('taskName').value = selected.name || '';
                document.getElementById('taskData').value = JSON.stringify(selected.suggestedData, null, 2);
                // Could show comments somewhere, e.g., alert or div
                if (selected.comments) {
                    alert(`Comments: ${selected.comments}`);
                }
            }
        });

        // Handle form submission
        document.getElementById('addTaskForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const selectedScript = document.getElementById('scriptSelect').value;
            const scriptItem = library.find(item => item.filename === selectedScript);
            if (!scriptItem) return;

            fetch(`/scripts/${selectedScript}`)
                .then(res => res.text())
                .then(scriptContent => {
                    const body = {
                        script: scriptContent,
                        name: document.getElementById('taskName').value || undefined,
                        data: JSON.parse(document.getElementById('taskData').value || '{}'),
                        transitions: JSON.parse(document.getElementById('transitions').value || '[]'),
                        status: parseInt(document.getElementById('status').value),
                        type: selectedScript.endsWith('.py') ? 'python' : selectedScript.endsWith('.sh') ? 'bash' : 'deno',
                        capabilitiesSchema: scriptItem.capabilitiesSchema
                    };

                    return fetch('/tasks', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            ...headers
                        },
                        body: JSON.stringify(body)
                    });
                })
                .then(res => res.json())
                .then(data => {
                    alert(`Task added! ID: ${data.id}`);
                    // Maybe redirect to task.html or clear form
                })
                .catch(err => {
                    console.error('Failed to add task:', err);
                    alert('Failed to add task');
                });
        });
    </script>
</body>

</html>