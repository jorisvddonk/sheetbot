<html>

<head>
    <script src="https://bossanova.uk/jspreadsheet/v4/jexcel.js"></script>
    <script src="https://jsuites.net/v4/jsuites.js"></script>
    <link rel="stylesheet" href="https://jsuites.net/v4/jsuites.css" type="text/css" />
    <link rel="stylesheet" href="https://bossanova.uk/jspreadsheet/v4/jexcel.css" type="text/css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/typescript.min.js"></script>
    <style>
        .jexcel > tbody > tr > td.readonly {
            color: black;
        }
    </style>
</head>

<body>
    <ul id="sheetlist"></ul>
    <div id="spreadsheet"></div>
    <script>
        // Fix a problem with jspreadsheet where Objects will be shown as '[object Object]'...
        // This is a very dirty fix!
        Object.defineProperty(Object.prototype, 'toString', {
            get() {
                return () => JSON.stringify(this, null, 2);
            },
            configurable: true,
        });

        const codeColumn = {
            closeEditor: function (cell, save) {
                // does not support editing!
            },
            openEditor: function (cell) {
                // does not support editing!
            },
            createCell: function (elem) {
                elem.innerHTML = `<pre><code class="hljs">${hljs.highlightAuto(elem.innerHTML).value}</code></pre>`;
                return elem;
            }
        }

        const imageColumn = {
            closeEditor: function (cell, save) {
                // does not support editing!
            },
            openEditor: function (cell) {
                // does not support editing!
            },
            createCell: function (elem) {
                const text = elem.innerHTML.trim();
                elem.innerHTML = `<img src="${text}" style="width: fit-content; height: fit-content; max-width: fit-content;"></img>`;
                return elem;
            }
        }

        const params = new URL(document.URL).searchParams;
        if (params.has("sheet")) {
            const data = fetch(`/sheets/${params.get("sheet")}`).then(response => {
                return response.json()
            }).then(data => {
                jspreadsheet(document.getElementById('spreadsheet'), {
                    data: data.rows,
                    columns: data.columns.map(columnDefinition => {
                        if (columnDefinition.widgettype === "number") {
                            return { type: 'number', name: columnDefinition.name, title: columnDefinition.name, width: columnDefinition.maxwidth, readOnly: true }   
                        } else if (columnDefinition.widgettype === "code") {
                            return { type: 'text', name: columnDefinition.name, title: columnDefinition.name, width: columnDefinition.maxwidth, editor: codeColumn, stripHTML: false, align: 'left', readOnly: true }
                        }  else if (columnDefinition.widgettype === "image") {
                            return { type: 'text', name: columnDefinition.name, title: columnDefinition.name, width: columnDefinition.maxwidth, editor: imageColumn, stripHTML: false, align: 'left', readOnly: true }
                        }  else if (columnDefinition.widgettype === "text") {
                            return { type: 'text', name: columnDefinition.name, title: columnDefinition.name, width: columnDefinition.maxwidth, readOnly: true, align: 'left' }
                        }
                        return { type: 'text', name: columnDefinition.name, title: columnDefinition.name, width: columnDefinition.maxwidth, readOnly: true }
                    })
                });
            });
        } else {
            const data = fetch(`/sheets`).then(response => {
                return response.json()
            }).then(data => {
                data.forEach(sheetName => {
                    const elem = document.createElement("a");
                    elem.innerText = sheetName;
                    elem.setAttribute("href", `/sheet.html?sheet=${sheetName}`);
                    const li = document.createElement("li");
                    li.appendChild(elem);
                    document.getElementById('sheetlist').appendChild(li);
                });
            });
        }

    </script>
</body>

</html>